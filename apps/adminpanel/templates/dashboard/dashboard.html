{% load i18n static admin_urls admin_list admin_dashboard %}

<style>
  /* Remove unnecessary vertical space and ensure auto height */
  .content, .container, .content-wrapper { min-height: auto; }
  #content { padding-bottom: 0; }
  #content > h1 { margin-bottom: 12px; }

  /* Responsive grids */
  .dash-grid-cards { display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
  .dash-grid-2 { display: grid; gap: 16px; grid-template-columns: 1fr; align-items: stretch; }
  @media (min-width: 1024px) { .dash-grid-2 { grid-template-columns: 1fr 1fr; } }
  .dash-grid-3 { display: grid; gap: 16px; grid-template-columns: 1fr; align-items: stretch; }
  @media (min-width: 768px) { .dash-grid-3 { grid-template-columns: 1fr 1fr; } }
  @media (min-width: 1280px) { .dash-grid-3 { grid-template-columns: 1fr 1fr 1fr; } }

  /* Cards */
  .dash-card { background: #ffffff; border: 1px solid #e5e7eb; border-radius: 14px; padding: 14px 16px; box-shadow: 0 1px 2px rgba(16,24,40,0.04), 0 1px 3px rgba(16,24,40,0.1); }
  .dash-card.pastel-rose { background: #fff6f6; }
  .dash-card.pastel-blue { background: #f0f8ff; }
  .dash-card.pastel-amber { background: #fef9e7; }
  .dash-card.pastel-mint { background: #f0fff7; }
  .dash-card.pastel-lilac { background: #f7f4ff; }
  .dash-k { font-weight: 600; font-size: 13px; color: #6b7280; }
  .dash-v { font-weight: 700; font-size: 22px; margin-top: 6px; color:#111827; }
  .dash-muted { color: #6b7280; }

  @media (prefers-color-scheme: dark){
    .dash-card{ background:#0f172a; border-color:#1f2937; }
    .dash-k{ color:#9ca3af; }
    .dash-v{ color:#e5e7eb; }
    .dash-muted{ color:#9ca3af; }
  }

  /* Chart containers to prevent long scroll */
  .chart-card { height: 260px; }
  .chart-card canvas { width: 100% !important; height: 100% !important; }

  /* Ensure default app list does not overlap */
  #app-list { margin-top: 20px; clear: both; }
  #app-list .module { clear: both; }

  /* Buttons */
  .btn { border:1px solid #e5e7eb; border-radius:8px; padding:6px 10px; text-decoration:none; }
  .btn:hover{ background:#f9fafb; }
  @media (prefers-color-scheme: dark){
    .btn{ border-color:#374151; color:#e5e7eb; }
    .btn:hover{ background:#111827; }
  }
</style>

<h1>{% trans 'Dashboard' %}</h1>

<!-- Top KPI Cards -->
<div class="dash-grid-cards">
  <a class="dash-card pastel-rose" href="{% url 'admin:users_user_changelist' %}">
    <div class="dash-k">{% trans 'Total Bettors' %}</div>
    <div class="dash-v">{% stat_total_users %}</div>
  </a>
  <a class="dash-card pastel-mint" href="{% url 'admin:users_user_changelist' %}?is_active__exact=1">
    <div class="dash-k">{% trans 'Active Bettors' %}</div>
    <div class="dash-v">{% stat_active_users %}</div>
  </a>
  <a class="dash-card pastel-lilac" href="{% url 'admin:bets_bet_changelist' %}?status__exact=placed">
    <div class="dash-k">{% trans 'Pending Bets' %}</div>
    <div class="dash-v">{% stat_pending_bets %}</div>
  </a>
  <a class="dash-card pastel-rose" href="{% url 'admin:payments_withdrawalrequest_changelist' %}?status__exact=pending">
    <div class="dash-k">{% trans 'Withdraw Requests' %}</div>
    <div class="dash-v">{% stat_pending_withdrawals %}</div>
  </a>
</div>

<!-- Summary financials -->
<div class="dash-grid-2" style="margin-top:16px;">
  <div class="dash-card">
    <div class="dash-k">{% trans 'Total Deposits (completed)' %}</div>
    <div class="dash-v">{{ sum_deposits_cents|default:0|cents_to_currency:"BDT" }}</div>
    <div class="dash-muted">{% trans 'Sum of completed deposit transactions' %}</div>
  </div>
  <div class="dash-card">
    <div class="dash-k">{% trans 'Total Withdrawals (completed)' %}</div>
    <div class="dash-v">{{ sum_withdrawals_cents|default:0|cents_to_currency:"BDT" }}</div>
    <div class="dash-muted">{% trans 'Sum of completed withdrawal transactions' %}</div>
  </div>
</div>

<!-- Two line charts: Deposits vs Withdrawals, Transactions +/- -->
<div class="dash-grid-2" style="margin-top:16px;">
  <div class="dash-card chart-card">
    <div class="dash-k">{% trans 'Deposit vs Withdraw Report' %}</div>
    <canvas id="chartDepositsWithdraws"></canvas>
  </div>
  <div class="dash-card chart-card">
    <div class="dash-k">{% trans 'Transactions Report' %}</div>
    <canvas id="chartTransactions"></canvas>
  </div>
</div>

<!-- Three donut charts: Browser / OS / Country -->
<div class="dash-grid-3" style="margin-top:16px;">
  <div class="dash-card chart-card">
    <div class="dash-k">{% trans 'Login by Browser' %}</div>
    <canvas id="chartBrowser"></canvas>
  </div>
  <div class="dash-card chart-card">
    <div class="dash-k">{% trans 'Login by OS' %}</div>
    <canvas id="chartOS"></canvas>
  </div>
  <div class="dash-card chart-card">
    <div class="dash-k">{% trans 'Login by Country' %}</div>
    <canvas id="chartCountry"></canvas>
  </div>
</div>

<!-- Quick links -->
<div style="margin-top:16px;">
  <div class="dash-k">{% trans 'Quick Links' %}</div>
  <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
    <a class="btn" href="{% url 'admin:payments_paymentintent_changelist' %}">{% trans 'Manage Deposits' %}</a>
    <a class="btn" href="{% url 'admin:payments_withdrawalrequest_changelist' %}">{% trans 'Manage Withdrawals' %}</a>
    <a class="btn" href="{% url 'admin:users_user_changelist' %}">{% trans 'Manage Users' %}</a>
    <a class="btn" href="{% url 'admin:sports_game_changelist' %}">{% trans 'Manage Games' %}</a>
  </div>
</div>

<!-- Chart.js and data loader -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  (function(){
    const el = (id) => document.getElementById(id);
    const toLineDataset = (rows, label, color) => ({
      label,
      data: rows.map(r => r.total_cents ? r.total_cents/100.0 : 0),
      borderColor: color,
      backgroundColor: color,
      tension: 0.25,
      fill: false,
    });
    const donutDataset = (items, label, colors) => ({
      labels: items.map(i => i.browser || i.os_type || i.location || 'N/A'),
      datasets: [{
        label,
        data: items.map(i => i.count || 0),
        backgroundColor: colors,
        hoverOffset: 4
      }]
    });

    const smallOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'bottom' }}, scales: { x: { grid: { display:false } }, y: { grid: { color:'#eee' }, ticks: { callback: (v)=> v }}} };
    const donutOptions = { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' }}};

    fetch('/api/admin/dashboard/charts/')
      .then(r => r.json())
      .then(data => {
        const labels = (data.deposits_daily || []).map(r => r.day);
        if (el('chartDepositsWithdraws')) {
          new Chart(el('chartDepositsWithdraws'), {
            type: 'line',
            data: {
              labels,
              datasets: [
                toLineDataset(data.deposits_daily || [], 'Deposits', '#10b981'),
                toLineDataset(data.withdraws_daily || [], 'Withdrawals', '#ef4444'),
              ]
            },
            options: smallOptions
          });
        }
        if (el('chartTransactions')) {
          new Chart(el('chartTransactions'), {
            type: 'line',
            data: {
              labels,
              datasets: [
                toLineDataset(data.transactions_plus_daily || [], '+ Transactions', '#3b82f6'),
                toLineDataset(data.transactions_minus_daily || [], '- Transactions', '#f59e0b'),
              ]
            },
            options: smallOptions
          });
        }
        const palette = ['#6366f1','#22c55e','#f59e0b','#06b6d4','#ef4444','#a855f7','#84cc16','#eab308'];
        if (el('chartBrowser')) new Chart(el('chartBrowser'), { type:'doughnut', data: donutDataset(data.login_by_browser || [], 'Browsers', palette), options: donutOptions });
        if (el('chartOS')) new Chart(el('chartOS'), { type:'doughnut', data: donutDataset(data.login_by_os || [], 'OS', palette), options: donutOptions });
        if (el('chartCountry')) new Chart(el('chartCountry'), { type:'doughnut', data: donutDataset(data.login_by_country || [], 'Country', palette), options: donutOptions });
      })
      .catch(() => { /* fail silent */ });
  })();
</script>
